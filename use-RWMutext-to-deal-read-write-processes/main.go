package main

import (
	"log"
	"math/rand"
	"sync"
	"time"
)

type Reader struct {
	id  int
	rwm *sync.RWMutex
}

type Writer struct {
	id  int
	rwm *sync.RWMutex
}

func main() {
	rwm := new(sync.RWMutex)

	for i := 0; i < 4; i++ {
		reader := &Reader{id: i, rwm: rwm}
		go reader.read()
	}

	for i := 0; i < 2; i++ {
		writer := &Writer{id: i, rwm: rwm}
		go writer.write()
	}

	time.Sleep(10 * time.Second)
}

func (r *Reader) read() {
	for {
		log.Printf("[reader%d] wanna read...", r.id)
		r.rwm.RLock()

		log.Printf("[reader%d] is reading...", r.id)
		randSleepMs(200, 500)
		log.Printf("[reader%d] finished reading", r.id)

		r.rwm.RUnlock()
		randSleepMs(1000, 1500)
	}
}

func (w *Writer) write() {
	for {
		log.Printf("[writer%d] is going to write...", w.id)
		w.rwm.Lock()

		log.Printf("[writer%d] is writting...", w.id)
		randSleepMs(500, 1000)
		log.Printf("[writer%d] finished writting", w.id)

		w.rwm.Unlock()

		randSleepMs(1000, 1500)
	}
}

func randSleepMs(min, max int) {
	time.Sleep(time.Duration(rand.Int()%(max-min)+min) * time.Millisecond)
}

/* output *****************************
2017/09/28 14:23:16 [reader0] wanna read...
2017/09/28 14:23:16 [reader0] is reading...
2017/09/28 14:23:16 [reader3] wanna read...
2017/09/28 14:23:16 [reader3] is reading...
2017/09/28 14:23:16 [reader1] wanna read...
2017/09/28 14:23:16 [reader1] is reading...
2017/09/28 14:23:16 [reader2] wanna read...
2017/09/28 14:23:16 [reader2] is reading...
2017/09/28 14:23:16 [writer0] is going to write...
2017/09/28 14:23:16 [writer1] is going to write...
2017/09/28 14:23:16 [reader1] finished reading
2017/09/28 14:23:17 [reader0] finished reading
2017/09/28 14:23:17 [reader3] finished reading
2017/09/28 14:23:17 [reader2] finished reading
2017/09/28 14:23:17 [writer0] is writting...
2017/09/28 14:23:17 [writer0] finished writting
2017/09/28 14:23:17 [writer1] is writting...
2017/09/28 14:23:18 [reader2] wanna read...
2017/09/28 14:23:18 [reader3] wanna read...
2017/09/28 14:23:18 [reader0] wanna read...
2017/09/28 14:23:18 [reader1] wanna read...
2017/09/28 14:23:18 [writer1] finished writting
2017/09/28 14:23:18 [reader1] is reading...
2017/09/28 14:23:18 [reader2] is reading...
2017/09/28 14:23:18 [reader3] is reading...
2017/09/28 14:23:18 [reader0] is reading...
2017/09/28 14:23:18 [reader2] finished reading
2017/09/28 14:23:18 [reader0] finished reading
2017/09/28 14:23:18 [reader3] finished reading
2017/09/28 14:23:18 [reader1] finished reading
2017/09/28 14:23:19 [writer0] is going to write...
2017/09/28 14:23:19 [writer0] is writting...
2017/09/28 14:23:19 [writer1] is going to write...
2017/09/28 14:23:19 [reader0] wanna read...
2017/09/28 14:23:20 [writer0] finished writting
2017/09/28 14:23:20 [reader0] is reading...
2017/09/28 14:23:20 [reader2] wanna read...
2017/09/28 14:23:20 [reader3] wanna read...
2017/09/28 14:23:20 [reader1] wanna read...
2017/09/28 14:23:20 [reader0] finished reading
2017/09/28 14:23:20 [writer1] is writting...
2017/09/28 14:23:21 [writer1] finished writting
2017/09/28 14:23:21 [reader1] is reading...
2017/09/28 14:23:21 [reader2] is reading...
2017/09/28 14:23:21 [reader3] is reading...
2017/09/28 14:23:21 [reader0] wanna read...
2017/09/28 14:23:21 [reader0] is reading...
2017/09/28 14:23:21 [writer0] is going to write...
2017/09/28 14:23:21 [reader1] finished reading
2017/09/28 14:23:21 [reader3] finished reading
2017/09/28 14:23:21 [reader2] finished reading
2017/09/28 14:23:21 [reader0] finished reading
2017/09/28 14:23:21 [writer0] is writting...
2017/09/28 14:23:22 [writer1] is going to write...
2017/09/28 14:23:22 [writer0] finished writting
2017/09/28 14:23:22 [writer1] is writting...
2017/09/28 14:23:22 [reader2] wanna read...
2017/09/28 14:23:22 [reader1] wanna read...
2017/09/28 14:23:23 [reader3] wanna read...
2017/09/28 14:23:23 [reader0] wanna read...
2017/09/28 14:23:23 [writer1] finished writting
2017/09/28 14:23:23 [reader0] is reading...
2017/09/28 14:23:23 [reader2] is reading...
2017/09/28 14:23:23 [reader1] is reading...
2017/09/28 14:23:23 [reader3] is reading...
2017/09/28 14:23:23 [reader3] finished reading
2017/09/28 14:23:23 [reader1] finished reading
2017/09/28 14:23:23 [reader0] finished reading
2017/09/28 14:23:23 [writer0] is going to write...
2017/09/28 14:23:23 [reader2] finished reading
2017/09/28 14:23:23 [writer0] is writting...
2017/09/28 14:23:24 [writer0] finished writting
2017/09/28 14:23:24 [reader3] wanna read...
2017/09/28 14:23:24 [reader3] is reading...
2017/09/28 14:23:24 [reader1] wanna read...
2017/09/28 14:23:24 [reader1] is reading...
2017/09/28 14:23:24 [writer1] is going to write...
2017/09/28 14:23:25 [reader3] finished reading
2017/09/28 14:23:25 [reader0] wanna read...
2017/09/28 14:23:25 [reader2] wanna read...
2017/09/28 14:23:25 [reader1] finished reading
2017/09/28 14:23:25 [writer1] is writting...
2017/09/28 14:23:25 [writer0] is going to write...
2017/09/28 14:23:26 [reader3] wanna read...
2017/09/28 14:23:26 [writer1] finished writting
2017/09/28 14:23:26 [reader0] is reading...
2017/09/28 14:23:26 [reader2] is reading...
2017/09/28 14:23:26 [reader3] is reading...
2017/09/28 14:23:26 [reader1] wanna read...
***************************************/
